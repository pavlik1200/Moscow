if("undefined"==typeof ELKPart)var ELKPart=function(){function a(){}function b(){a();var b="=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/;"+("https"=='https'?"secure;":"")+"domain=";document.cookie="elk_token"+b+document.location.hostname,document.cookie="elk_id"+b+'.mos.ru'}function c(){for(var a=0,b=p.length;b>a;++a)p[a]();p=[]}function d(){return(l=/elk_id=([a-f\d]+)/.exec(document.cookie))?(l=l[1],a(),(k=new RegExp("elk_token="+l+"\\|([a-f\\d]+)").exec(document.cookie))?(k=k[1],c(),void 0):!0):!1}function e(a,b){l&&window.sessionStorage&&window.sessionStorage.setItem("ELK/"+l+a,JSON.stringify(b)),s[a]=b}function f(a){return a in s?{memory:!0,data:s[a]}:l&&window.sessionStorage?{data:JSON.parse(window.sessionStorage.getItem(l+a))}:{data:!1}}function g(a){delete s[a];try{window.sessionStorage.removetItem("ELK/"+l+a)}catch(b){}}function h(a,c,d){var g=c.hasOwnProperty("loadFromLocalStorage")?c.loadFromLocalStorage:!0,h=f(a);if(h.data&&g){if(c.done&&"function"==typeof c.done&&c.done(h.data),h.memory)return}else c.before&&"function"==typeof c.before&&c.before();t.request({method:"GET",url:"/data/"+k+a+(/\?/.test(a)?"&":"?")+"_="+ ++o},function(f){if(200===f.status){var g;try{g=JSON.parse(f.data)}catch(i){g={error:{code:403,message:ELK.errors.NOT_SIGNED_IN}}}if(g.error)403===g.error.code&&b(),c.fail&&"function"==typeof c.fail&&c.fail(g.error.message);else{var j=!1;if(d){var k={};if("undefined"!=typeof g.length)for(var l=0,m=g.length;m>l;l++){var n=g[l];k[n.code]=n.data,j=!0}else"undefined"!=typeof g.code&&(k[g.code]=g.data,j=!0);g=k;var o={LEGAL_REG_INFO:["INN_DATE","OGRN_DATE","REG_DATE","HEAD","HEAD_POSITION","REGISTRATOR_NAME"],LEGAL_INFO:["ADDRESS","CONTACT_ADDRESS","FAX"],LEGAL_DRIVER:["DESCRIPTION"],LEGAL_VEHICLE:["GPS","OSAGO_DATE","OSAGO_END_DATE","OSAGO_INSURENCE_COMPANY_NAME","OSAGO_NUMBER","OSAGO_START_DATE","TAXIMETER"]};Object.keys(g).filter(function(a){return o[a]}).forEach(function(a){return Array.isArray(g[a])?(g[a].forEach(function(b){o[a].forEach(function(a){delete b[a]})}),void 0):(o[a].forEach(function(b){delete g[a][b]}),void 0)})}else j=!0;j&&e(a,g),c.done&&"function"==typeof c.done&&c.done(g)}}else 403===f.status&&b(),c.fail&&"function"==typeof c.fail&&c.fail("Произошла ошибка при обращении к серверу ("+f.status+" "+f.statusText+"). Рекомендуем повторить попытку позже.");!h.data&&c.after&&"function"==typeof c.after&&c.after()})}function i(a,b){function c(a){try{var b=JSON.parse(a.data);if(b&&"object"==typeof b&&"ELK-message"===b.type){var c=b.subtype;"UNREAD"===c&&g("/activity/digest");var d=v[c];d&&d(a.origin,b.data)}}catch(e){}}v[a]=b,u||(window.addEventListener?window.addEventListener("message",c,!1):window.attachEvent("onmessage",c),u=!0)}function j(a){function b(a,d){var e,f;if(d instanceof Array)for(e=0,f=d.length;f>e;++e)b(a+"["+e+"]",d[e]);else if(d instanceof Object)for(e in d)b(a+"["+e+"]",d[e]);else c[a]=d}var c={};for(var d in a)b(d,a[d]);return c}var k,l,m='https'+"://"+'my.mos.ru',n=0,o=(new Date).getTime(),p=[];if(!d()){window.onCookieLoad=d;var q=document.getElementsByTagName("head")[0],r=document.createElement("script");r.type="text/javascript",r.src='https'+"://"+'my.mos.ru'+"/static/js/cookie.js?_="+ ++o,q.appendChild(r)}var s={};Date.now||(Date.now=function(){return(new Date).getTime()});var t=new easyXDM.Rpc({remote:m+"/static/xdm/index.html?nocache="+Date.now()},{remote:{request:{}},serializer:{parse:function(a){return JSON.parse(a)},stringify:function(a){return JSON.stringify(a)}}}),u=!1,v={};return{errors:{NOT_READY:"Не готов транспорт для работы с ЕЛК",NOT_SIGNED_IN:"Не произведен вход в систему"},ready:function(a){k?a():p.push(a)},requestToken:function(a,d){d&&d.before&&d.before(),t.request({method:"POST",url:"/data/token",data:a},function(a){if(200===a.status){var e;try{e=JSON.parse(a.data)}catch(f){e={error:{code:403,message:ELK.errors.NOT_SIGNED_IN}}}if(e.error)403===e.error.code&&b(),d&&d.fail&&d.fail(e.error.message);else{var g=new Date;g.setDate(g.getDate()+1),document.cookie="elk_token="+l+"|"+e.token+";path=/;"+("https"=='https'?"secure;":"")+"expires="+g.toUTCString(),d&&d.done&&d.done(),k=e.token,c()}}else 403===a.status&&b(),d&&d.fail&&d.fail("Произошла ошибка при обращении к серверу ("+a.status+" "+a.statusText+"). Рекомендуем повторить попытку позже.");d&&d.after&&d.after()},function(a){403===a.code&&b(),d&&d.fail&&d.fail(a.message),d&&d.after&&d.after()})},loadUserStatus:function(a,b){k?h("/status?site_id="+a,b):b&&b.fail&&b.fail(this.errors.NOT_READY)},setUserStatusChangedTarget:function(a){n=a},onUserStatusChanged:function(a){i("FIO",a)},onUnreadActivityChanged:function(a){i("UNREAD",a)},loadActivityDigest:function(a){k?h("/activity/digest",a):a&&a.fail&&a.fail(this.errors.NOT_READY)},loadUserProfileData:function(a){var b=a.blocks instanceof Array?a.blocks.join(","):a.blocks,c=a.hasOwnProperty("trusteeGuid")&&a.trusteeGuid?"?trusteeProfile="+a.trusteeGuid:"";k?h("/profile/"+(a.part?a.part:"me")+"/"+b+"/"+c,a,!0):a.fail&&a.fail(this.errors.NOT_READY)},getSubscriptionChannels:function(a){k?h("/subscribe/channels",a):a&&a.fail&&a.fail(this.errors.NOT_READY)},getSubscriptionSettings:function(a){k?h("/subscribe/settings",a):a&&a.fail&&a.fail(this.errors.NOT_READY)},saveSubscriptionSettings:function(a){a.before&&"function"==typeof a.before&&a.before(),t.request({method:"POST",url:"/data/"+k+"/subscribe/settings",data:j(a.data)},function(c){if(200===c.status){var d;try{d=JSON.parse(c.data)}catch(e){d={error:{code:403,message:ELK.errors.NOT_SIGNED_IN}}}d.error?(403===d.error.code&&b(),a.fail&&"function"==typeof a.fail&&a.fail(d.error.message)):a.done&&"function"==typeof a.done&&a.done(d)}else 403===c.status&&b(),a.fail&&"function"==typeof a.fail&&a.fail("Произошла ошибка при обращении к серверу ("+c.status+" "+c.statusText+"). Рекомендуем повторить попытку позже.");a.after&&"function"==typeof a.after&&a.after()},function(c){403===c.code&&b(),a.fail&&"function"==typeof a.fail&&a.fail(c.message),a.after&&"function"==typeof a.after&&a.after()})},diaryCheck:function(a,b){"use strict";var c=$.Deferred();if(a.PASSWORD=a.PASSWORD?md5(a.PASSWORD):"",void 0!==b&&(b.PASSWORD=/^[A-F0-9]{32}$/i.test(b.PASSWORD)?b.PASSWORD:md5(b.PASSWORD)),void 0!==b&&b.PASSWORD===a.PASSWORD&&b.LOGIN===a.LOGIN)c.resolve(a);else{var d="";void 0!==b&&b.LOGIN!=a.LOGIN||void 0===b?d="getUserId?login="+a.LOGIN+"&pass="+a.PASSWORD:void 0!==b&&b.PASSWORD!=a.PASSWORD&&b.LOGIN===a.LOGIN&&(d="changeAuthCredentials?login="+a.LOGIN+"&pass="+b.PASSWORD+"&newpass="+a.PASSWORD);var e=function(a,b,c,d,e){t.request({method:"GET",url:"/data/mrko/"+a,headers:{"Content-Type":"application/json"}},function(a){if(200===a.status){var f=JSON.parse(a.data);0===f.errorCode?(b.SYSTEM="m",c.resolve(b)):(d||(d=f.errorMessage),e||(e=200),c.reject({code:e,message:d}))}else c.reject({code:a.status,message:"Приносим свои извинения, в электронном дневнике ведутся технические работы. Рекомендуем повторить попытку позже."})},function(){c.reject({code:500,message:"Приносим свои извинения, в электронном дневнике ведутся технические работы. Рекомендуем повторить попытку позже."})})};t.request({method:"GET",url:"/data/ejd/"+d,headers:{"Content-Type":"application/json"}},function(b){if(200===b.status){var f=JSON.parse(b.data);0===f.errorCode?(a.SYSTEM="e",c.resolve(a)):e(d,a,c,null,null)}else{var g="Приносим свои извинения, в электронном дневнике ведутся технические работы. Рекомендуем повторить попытку позже.",h=b.status;e(d,a,c,g,h)}},function(){var b="Приносим свои извинения, в электронном дневнике ведутся технические работы. Рекомендуем повторить попытку позже.",f=500;e(d,a,c,b,f)})}return c.promise()},saveUserProfileData:function(a){var c=a.block,d="/profile/"+(a.part?a.part:"me");a.before&&a.before(),t.request({method:"POST",url:"/data/"+k+d+"/"+c+"/edit",data:j({code:c,data:a.data})},function(g){if(200===g.status){var h;try{h=JSON.parse(g.data)}catch(i){h={error:{code:403,message:ELK.errors.NOT_SIGNED_IN}}}if(h.error)403===h.error.code&&b(),a.fail&&a.fail(h.error.message);else{var j=f(d).data;if(j||(j={}),c in j&&!(a.data instanceof Array))for(var k in a.data)j[c][k]=a.data[k];else j[c]=a.data;e(d,j),n&&"FIO"===c&&window.parent.postMessage(JSON.stringify({type:"ELK-message",data:a.data}),n);var l={};l[c]=a.data,l.response=g.data,a.done&&a.done(l)}}else 403===g.status&&b(),a.fail&&a.fail("Произошла ошибка при обращении к серверу ("+g.status+" "+g.statusText+"). Рекомендуем повторить попытку позже.");a.after&&a.after()},function(c){403===c.code&&b(),a.fail&&a.fail(c.message),a.after&&a.after()})},loadRelatives:function(a){k?h("/data/"+k+"/relatives",a):a.fail&&a.fail(this.errors.NOT_READY)}}}();if("undefined"==typeof ELK)var ELK={};for(var attrname in ELKPart)ELK[attrname]=ELKPart[attrname];